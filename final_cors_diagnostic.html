<!DOCTYPE html>
<html>
<head>
    <title>üö® FINAL CORS DIAGNOSTIC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f0f8ff; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 8px;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .countdown { font-size: 18px; font-weight: bold; color: #856404; }
        h1 { color: #0c5460; text-align: center; }
        .step { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® FINAL CORS DIAGNOSTIC</h1>
        
        <div class="status warning">
            <strong>‚è±Ô∏è Deployment Status:</strong>
            <div class="countdown" id="countdown">Waiting for final CORS fix deployment... (3 minutes remaining)</div>
        </div>
        
        <div class="step">
            <h2>üîß What Was Fixed This Time:</h2>
            <ul>
                <li>‚úÖ Fixed the CORS test endpoint import issue</li>
                <li>‚úÖ Moved CORS endpoint directly into urls.py</li>
                <li>‚úÖ Set <code>CORS_ALLOW_ALL_ORIGINS = True</code> at the top of settings</li>
                <li>‚úÖ Added comprehensive CORS headers and methods</li>
                <li>‚úÖ This should definitely work now!</li>
            </ul>
        </div>
        
        <div class="step">
            <h2>üß™ Test Sequence:</h2>
            <button onclick="testSequence()">üöÄ Run Full Test Sequence</button>
            <button onclick="testBackendHealth()">üíì Test Backend Health</button>
            <button onclick="testCORSEndpoint()">üîç Test CORS Endpoint</button>
            <button onclick="testOriginalRecipe()">üç≥ Test Recipe Endpoint</button>
        </div>
        
        <div id="results"></div>
    </div>
    
    <script>
        const backendURL = 'https://onlypans.onrender.com/api';
        let countdownSeconds = 180; // 3 minutes
        
        // Countdown timer
        const countdownInterval = setInterval(() => {
            countdownSeconds--;
            const minutes = Math.floor(countdownSeconds / 60);
            const seconds = countdownSeconds % 60;
            document.getElementById('countdown').innerHTML = 
                `Waiting for final CORS fix deployment... (${minutes}:${seconds.toString().padStart(2, '0')} remaining)`;
            
            if (countdownSeconds <= 0) {
                clearInterval(countdownInterval);
                document.getElementById('countdown').innerHTML = '‚úÖ Deployment complete! Running tests...';
                testSequence(); // Auto-test
            }
        }, 1000);
        
        function addResult(content) {
            document.getElementById('results').innerHTML += content;
        }
        
        async function testBackendHealth() {
            addResult('<div class="status info">üîç Testing backend health...</div>');
            
            try {
                const response = await fetch(backendURL + '/health/');
                const data = await response.json();
                
                if (response.ok) {
                    addResult(`
                        <div class="status success">
                            ‚úÖ Backend Health: OK
                            <br><strong>Status:</strong> ${response.status}
                            <br><strong>Message:</strong> ${data.message}
                        </div>
                    `);
                    return true;
                } else {
                    addResult(`<div class="status error">‚ùå Backend Health: Failed (${response.status})</div>`);
                    return false;
                }
            } catch (error) {
                addResult(`<div class="status error">‚ùå Backend Health: Error - ${error.message}</div>`);
                return false;
            }
        }
        
        async function testCORSEndpoint() {
            addResult('<div class="status info">üîç Testing CORS debug endpoint...</div>');
            
            try {
                const response = await fetch(backendURL + '/cors-test/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`
                        <div class="status success">
                            ‚úÖ CORS Endpoint: Working!
                            <br><strong>CORS Settings:</strong>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `);
                    return true;
                } else {
                    addResult(`<div class="status error">‚ùå CORS Endpoint: Failed (${response.status})</div>`);
                    return false;
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult(`<div class="status error">‚ùå CORS Endpoint: Still blocked by CORS - ${error.message}</div>`);
                } else {
                    addResult(`<div class="status error">‚ùå CORS Endpoint: Network error - ${error.message}</div>`);
                }
                return false;
            }
        }
        
        async function testOriginalRecipe() {
            addResult('<div class="status info">üîç Testing original failing recipe endpoint...</div>');
            
            try {
                const response = await fetch(backendURL + '/recipes/generate/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredients: 'eggs, cheese',
                        dietary_restrictions: '',
                        cuisine_preference: 'American',
                        difficulty_preference: 'Easy',
                        servings: 2
                    })
                });
                
                if (response.status === 401) {
                    addResult(`
                        <div class="status success">
                            ‚úÖ Recipe Endpoint: CORS FIXED!
                            <br><strong>Status:</strong> 401 Unauthorized (expected - requires login)
                            <br><strong>üéâ The original CORS error is gone!</strong>
                            <br><br><strong>‚ú® Your Vercel app should now work!</strong>
                        </div>
                    `);
                    return true;
                } else {
                    const data = await response.json();
                    addResult(`
                        <div class="status warning">
                            ‚ö†Ô∏è Recipe Endpoint: Unexpected response (${response.status})
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `);
                    return true; // Still counts as working if we get a response
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult(`<div class="status error">‚ùå Recipe Endpoint: Still blocked by CORS - ${error.message}</div>`);
                } else {
                    addResult(`<div class="status error">‚ùå Recipe Endpoint: Network error - ${error.message}</div>`);
                }
                return false;
            }
        }
        
        async function testSequence() {
            document.getElementById('results').innerHTML = '<h2>üöÄ Running Full Test Sequence...</h2>';
            
            const healthOK = await testBackendHealth();
            if (!healthOK) {
                addResult('<div class="status error">‚ùå Backend is down. Cannot continue testing.</div>');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
            
            const corsOK = await testCORSEndpoint();
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
            
            const recipeOK = await testOriginalRecipe();
            
            // Final summary
            if (corsOK && recipeOK) {
                addResult(`
                    <div class="status success" style="margin-top: 20px; font-size: 18px;">
                        üéâ <strong>SUCCESS! CORS IS FIXED!</strong>
                        <br><br>Your Vercel app should now work properly:
                        <br><a href="https://onlypans-2n0yp79t8-stanondiekis-projects.vercel.app" target="_blank" style="color: #0066cc; font-weight: bold;">
                        ‚Üí Test Your App Now ‚Üê
                        </a>
                    </div>
                `);
            } else {
                addResult(`
                    <div class="status error" style="margin-top: 20px;">
                        ‚ùå <strong>CORS is still not working</strong>
                        <br>We may need to try a different deployment approach or check Render's logs.
                    </div>
                `);
            }
        }
    </script>
</body>
</html>
